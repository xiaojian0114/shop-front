# 龚祺辉 - 客户端功能模块讲解文档

## 📋 负责模块概览

你负责以下三个核心模块：
1. **客户端首页** - 商品搜索与展示 (`src/pages/user/index.vue`)
2. **商品详情页面** - 商品信息展示与购买 (`src/pages/common/goods-detail.vue`)
3. **个人中心页面** - 用户信息与订单管理 (`src/pages/user/mine.vue`)

---

## 一、客户端首页 (`src/pages/user/index.vue`)

### 1.1 实现的功能
- **商品搜索**：实时搜索商品，支持关键词匹配
- **精选推荐轮播**：自动轮播展示热门商品
- **商品列表展示**：网格布局展示所有商品
- **加入购物车**：一键将商品添加到购物车

### 1.2 实现方法

#### 商品搜索功能
**实现方式**：通过 `onSearchInput` 方法监听输入框，使用 `setTimeout` 实现300ms防抖，避免频繁请求。当用户输入关键词后，调用 `productApi.searchProducts()` 接口搜索商品。

**关键方法**：
- `onSearchInput()` - 监听搜索输入，实现防抖
- `search(keyword)` - 执行搜索请求

**使用的API**：`productApi.searchProducts({ keyword })`

#### 精选推荐轮播
**实现方式**：从商品列表中取前3个作为轮播图，使用 `setInterval` 定时器每3秒自动切换。通过 `currentIndex` 控制当前显示的轮播项，使用CSS类名绑定实现切换效果。

**关键方法**：
- `startCarousel()` - 启动轮播定时器
- 页面隐藏时清除定时器，避免内存泄漏

#### 商品列表展示
**实现方式**：页面加载时调用 `productApi.getProductList()` 获取商品列表，使用 `v-for` 循环渲染商品卡片。每个商品卡片显示图片、名称、价格、销量和"加入购物车"按钮。

**关键方法**：
- `initPage()` - 初始化页面，加载商品列表
- 检查登录状态，未登录跳转登录页

#### 加入购物车功能
**实现方式**：点击"加入购物车"按钮时，调用 `userApi.addToCart()` 接口，传递商品ID和数量（默认1）。成功后显示提示，失败则提示错误信息。

**关键方法**：
- `addCart(goods)` - 添加商品到购物车

**使用的API**：`userApi.addToCart({ productId, num })`

### 1.3 核心要点
1. **防抖处理**：搜索输入使用300ms防抖，减少服务器压力
2. **轮播图管理**：页面隐藏时清除定时器，避免内存泄漏
3. **登录校验**：页面加载时检查token，未登录自动跳转
4. **样式统一**：使用渐变背景、卡片阴影、圆角等统一设计语言

---

## 二、商品详情页面 (`src/pages/common/goods-detail.vue`)

### 2.1 实现的功能
- **商品图片展示**：支持单图或多图轮播（多图用 `|` 分隔）
- **商品信息展示**：价格、销量、名称、描述
- **店铺信息展示**：显示商品所属店铺，可跳转店铺详情
- **购买操作**：加入购物车或立即购买

### 2.2 实现方法

#### 商品详情加载
**实现方式**：页面加载时从路由参数获取商品ID，调用 `productApi.getProductDetail()` 获取商品详情。处理商品图片（支持多图，用 `|` 分隔），如果商品有关联店铺，则调用 `userApi.getShopInfo()` 加载店铺信息。

**关键方法**：
- `loadDetail()` - 加载商品详情
- `loadShopInfo(shopId)` - 加载店铺信息

**使用的API**：
- `productApi.getProductDetail(id)`
- `userApi.getShopInfo(shopId)`

#### 图片处理
**实现方式**：检查商品图片字段，如果包含 `|` 则分割为数组，否则作为单图处理。使用 `swiper` 组件实现轮播展示。

#### 加入购物车
**实现方式**：检查登录状态，未登录跳转登录页。已登录则调用 `userApi.addToCart()` 接口添加商品。

**关键方法**：
- `addCart()` - 加入购物车

#### 立即购买
**实现方式**：点击"立即购买"按钮，跳转到订单确认页面，通过URL参数传递商品ID。

**关键方法**：
- `buyNow()` - 跳转到订单确认页

### 2.3 核心要点
1. **图片处理**：支持单图或多图，多图使用轮播展示
2. **店铺关联**：通过 `shopId` 加载并展示店铺信息
3. **错误处理**：商品不存在时提示并自动返回
4. **HTML渲染**：商品描述使用 `v-html` 渲染（注意XSS安全）

---

## 三、个人中心页面 (`src/pages/user/mine.vue`)

### 3.1 实现的功能
- **用户信息展示**：头像、昵称、手机号
- **订单统计**：待支付、待发货、待收货、已完成订单数量
- **快捷入口**：订单列表、购物车
- **退出登录**：清除本地数据并跳转登录页

### 3.2 实现方法

#### 用户信息加载
**实现方式**：页面显示时检查本地token，如果有token则调用 `userApi.getUserInfo()` 获取用户信息。获取成功后更新头像URL（处理完整URL、OSS URL、相对路径三种格式），并将用户信息保存到本地存储。

**关键方法**：
- `loadUserInfo()` - 加载用户信息
- `updateAvatarUrl()` - 处理头像URL（支持完整URL、OSS URL、相对路径）

**使用的API**：`userApi.getUserInfo()`

#### 订单统计
**实现方式**：调用 `userApi.getOrderList()` 获取全部订单（status=0），然后在前端按订单状态分类统计。订单状态码：1=待支付，2=待发货，3=已发货，4=已完成。

**关键方法**：
- `loadOrderStats()` - 加载订单统计

**使用的API**：`userApi.getOrderList({ status: 0 })`

#### 头像URL处理（重要）
**实现方式**：检查头像URL格式，如果是完整HTTP/HTTPS URL直接使用；如果是OSS URL（包含 `oss-cn` 或 `aliyuncs.com`），添加 `https://` 前缀；如果是相对路径，拼接 `BASE_URL`。

**关键方法**：
- `updateAvatarUrl()` - 统一处理头像URL格式

#### 退出登录
**实现方式**：显示确认弹窗，用户确认后清除所有本地存储（`uni.clearStorageSync()`），然后使用 `uni.reLaunch()` 重启到登录页。

**关键方法**：
- `logout()` - 退出登录

### 3.3 核心要点
1. **头像URL处理**：支持三种URL格式，统一处理逻辑
2. **订单统计**：前端过滤统计，避免多次请求
3. **下拉刷新**：支持下拉刷新用户信息和订单统计
4. **本地存储**：用户信息缓存在本地，提高加载速度
5. **退出登录**：清除所有本地数据，确保安全

---

## 四、技术要点总结

### 4.1 图片URL处理
项目中图片URL有三种格式：
- **完整URL**：`https://example.com/image.jpg` - 直接使用
- **OSS URL**：`//my-bucket.oss-cn-shanghai.aliyuncs.com/images/xxx.jpg` - 需要添加 `https:`
- **相对路径**：`/images/xxx.jpg` - 需要拼接 `BASE_URL`

**处理位置**：`src/pages/user/mine.vue` 的 `updateAvatarUrl()` 方法

### 4.2 防抖与节流
- **搜索防抖**：300ms延迟，避免频繁请求（`src/pages/user/index.vue`）
- **轮播定时器**：页面隐藏时清除，避免内存泄漏（`src/pages/user/index.vue`）

### 4.3 路由导航
- `uni.navigateTo()` - 保留当前页面，跳转到新页面
- `uni.switchTab()` - 跳转到tabBar页面
- `uni.reLaunch()` - 关闭所有页面，打开新页面
- `uni.navigateBack()` - 返回上一页

### 4.4 状态管理
- 使用 `uni.getStorageSync()` / `uni.setStorageSync()` 进行本地存储
- Token存储在 `token` 键中
- 用户信息存储在 `userInfo` 键中

### 4.5 错误处理
- API请求失败时使用 `try-catch` 捕获
- 使用 `uni.showToast` 显示用户友好的错误提示
- 关键操作失败时提供重试机制

---

## 五、常见问题与解决方案

### Q1: 头像不显示？
**A**: 检查头像URL格式，使用 `updateAvatarUrl()` 方法统一处理（`src/pages/user/mine.vue`）

### Q2: 搜索没有结果？
**A**: 检查后端搜索接口是否正常，检查关键词是否正确传递（`src/pages/user/index.vue`）

### Q3: 轮播图不自动切换？
**A**: 检查 `startCarousel()` 是否在数据加载后调用，检查定时器是否被清除（`src/pages/user/index.vue`）

### Q4: 订单统计不准确？
**A**: 检查订单状态码是否正确（1=待支付，2=待发货，3=已发货，4=已完成）（`src/pages/user/mine.vue`）

---

## 六、代码规范建议

1. **命名规范**：使用驼峰命名，方法名使用动词开头
2. **注释规范**：关键逻辑添加注释说明
3. **错误处理**：所有异步操作都要有错误处理
4. **性能优化**：合理使用防抖、节流，及时清除定时器
5. **用户体验**：加载状态提示，操作反馈及时

---

## 七、扩展功能建议

1. **首页**：可添加分类筛选、排序功能
2. **商品详情**：可添加商品评价、相关推荐
3. **个人中心**：可添加收货地址管理、优惠券功能

---

**文档版本**: v2.0  
**最后更新**: 2024年  
**维护者**: 龚祺辉
