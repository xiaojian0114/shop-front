# 乔雨林 - 商家端功能模块讲解文档

## 📋 负责模块概览

你负责以下核心模块：
1. **商家端个人中心** - 商家信息与数据统计 (`src/pages/merchant/mine.vue`)
2. **订单管理页面** - 订单列表、发货管理 (`src/pages/merchant/order-manage.vue`)
3. **店铺申请页面** - 新店铺申请 (`src/pages/merchant/apply-shop.vue`)
4. **首页商品展示与搜索** - 与客户端共享 (`src/pages/user/index.vue`)

---

## 一、商家端个人中心 (`src/pages/merchant/mine.vue`)

### 1.1 实现的功能
- **商家信息展示**：头像、昵称、手机号、店铺名称、店铺状态
- **数据统计展示**：待发货订单数、今日订单数、商品总数
- **快捷功能入口**：订单管理、店铺管理、商品管理

### 1.2 实现方法

#### 商家信息加载
**实现方式**：页面加载时调用 `merchantApi.getMerchantInfo()` 获取商家信息（包含店铺信息）。获取成功后处理头像URL（与客户端个人中心使用相同的URL处理逻辑），并显示店铺状态。

**关键方法**：
- `loadMerchantInfo()` - 加载商家信息
- `updateAvatarUrl()` - 处理头像URL

**使用的API**：`merchantApi.getMerchantInfo()`

#### 订单统计展示
**实现方式**：调用 `merchantApi.getOrderStats()` 获取统计数据，直接显示后端返回的数据，无需前端计算。统计数据包括：待发货订单数、今日订单数、商品总数。

**关键方法**：
- `loadOrderStats()` - 加载订单统计

**使用的API**：`merchantApi.getOrderStats()`

#### 店铺状态显示
**实现方式**：根据 `shopInfo.status` 显示不同状态标签。状态码：0=审核中（橙色），1=已通过（绿色），2=已拒绝（红色）。

**关键方法**：
- `getStatusText(status)` - 获取状态文本
- `getStatusClass(status)` - 获取状态样式类

### 1.3 核心要点
1. **数据统计**：直接显示后端返回的统计数据，无需前端计算
2. **店铺状态**：根据状态码显示不同颜色的标签
3. **头像处理**：与客户端个人中心使用相同的URL处理逻辑

---

## 二、订单管理页面 (`src/pages/merchant/order-manage.vue`)

### 2.1 实现的功能
- **订单统计展示**：待发货、今日订单、商品总数
- **订单筛选**：全部、待发货、已发货
- **订单列表展示**：订单号、状态、商品信息、总金额
- **发货功能**：待发货订单可发货
- **订单详情查看**：跳转到订单详情页

### 2.2 实现方法

#### 订单列表加载
**实现方式**：调用 `merchantApi.order.getList()` 获取订单列表。处理后端返回的数据，确保格式统一（兼容 `items` 和 `orderItems` 两种字段名）。

**关键方法**：
- `loadOrders()` - 加载订单列表
- `getOrderItems(order)` - 获取订单商品项（处理数据兼容）

**使用的API**：`merchantApi.order.getList()`

#### 订单筛选
**实现方式**：使用计算属性 `filteredOrders` 实现前端筛选。根据 `currentFilter` 的值（all/pending/delivered）过滤订单列表。订单状态码：2=待发货，3=已发货。

**关键方法**：
- `changeFilter(filter)` - 切换筛选条件
- `filteredOrders`（计算属性）- 根据筛选条件过滤订单

#### 发货功能
**实现方式**：点击"发货"按钮时，显示确认弹窗。用户确认后调用 `merchantApi.order.deliver(orderId)` 接口发货。发货成功后刷新订单列表和统计。

**关键方法**：
- `deliverOrder(orderId)` - 发货操作

**使用的API**：`merchantApi.order.deliver(orderId)`

#### 订单状态显示
**实现方式**：根据订单状态码显示不同颜色的状态标签。状态码：1=待付款（橙色），2=待发货（主色），3=已发货（蓝色），4=已完成（绿色），5=已取消（灰色）。

**关键方法**：
- `getStatusText(status)` - 获取状态文本
- `getStatusClass(status)` - 获取状态样式类

### 2.3 核心要点
1. **订单筛选**：使用计算属性实现前端筛选，提高响应速度
2. **数据兼容**：处理后端返回的不同字段名（`items` vs `orderItems`）
3. **发货确认**：发货前使用模态框确认，避免误操作
4. **状态更新**：发货后立即刷新订单列表和统计

---

## 三、店铺申请页面 (`src/pages/merchant/apply-shop.vue`)

### 3.1 实现的功能
- **店铺名称输入**：2-20个字符，实时字符计数
- **店铺头像上传**：图片选择、上传到OSS、预览
- **表单验证**：名称长度验证、头像必填验证
- **提交申请**：确认弹窗、加载状态、成功后返回

### 3.2 实现方法

#### 图片上传功能
**实现方式**：使用 `uni.chooseImage()` 选择本地图片，选择成功后调用 `merchantApi.uploadImage()` 上传到OSS。上传成功后获取OSS返回的完整URL，保存到表单数据中，并显示预览。

**关键方法**：
- `chooseLogo()` - 选择并上传头像

**使用的API**：`merchantApi.uploadImage(filePath)`

**上传流程**：
1. 选择图片（`uni.chooseImage()`）
2. 上传到OSS（`merchantApi.uploadImage()`）
3. 获取OSS URL
4. 保存URL到表单
5. 显示预览

#### 表单验证
**实现方式**：前端验证店铺名称长度（2-20字符）和头像必填。验证失败时使用 `uni.showToast` 提示用户。

**关键方法**：
- `submit()` - 提交前验证表单

#### 提交申请
**实现方式**：验证通过后显示确认弹窗，用户确认后调用 `merchantApi.applyShop()` 提交申请。提交时显示加载状态，禁用按钮防止重复提交。成功后提示并返回上一页。

**关键方法**：
- `submit()` - 提交店铺申请

**使用的API**：`merchantApi.applyShop({ name, logo })`

#### Logo URL处理
**实现方式**：处理三种URL格式（完整URL、OSS URL、相对路径），确保预览正常显示。

**关键方法**：
- `getLogoUrl(logo)` - 处理Logo URL

### 3.3 核心要点
1. **图片上传**：使用封装的 `uploadImage` 工具，自动上传到OSS
2. **表单验证**：前端验证名称长度、头像必填，提供友好提示
3. **确认机制**：提交前使用模态框确认，避免误操作
4. **加载状态**：上传和提交时显示加载状态，禁用按钮防止重复提交
5. **字符计数**：实时显示已输入字符数 / 最大字符数

---

## 四、首页商品展示与搜索（共享模块）

### 4.1 功能说明
此模块与客户端首页共享 (`src/pages/user/index.vue`)，详见《龚祺辉-客户端功能讲解.md》中的"一、客户端首页"部分。

### 4.2 你的职责
- 确保首页商品展示功能正常
- 确保商品搜索功能正常
- 与客户端开发者协调样式统一

---

## 五、技术要点总结

### 5.1 图片上传流程
**实现位置**：`src/pages/merchant/apply-shop.vue` 的 `chooseLogo()` 方法

**流程步骤**：
1. 选择图片：`uni.chooseImage()` 选择本地图片
2. 上传到OSS：调用 `merchantApi.uploadImage()` 上传
3. 获取URL：后端返回OSS完整URL
4. 保存URL：将URL保存到表单数据中
5. 显示预览：使用返回的URL显示图片预览

### 5.2 订单状态码
- `1` - 待付款（用户未支付）
- `2` - 待发货（商家需发货）
- `3` - 已发货（等待用户确认收货）
- `4` - 已完成（交易完成）
- `5` - 已取消

### 5.3 店铺状态码
- `0` - 审核中（等待管理员审核）
- `1` - 已通过（可以正常使用）
- `2` - 已拒绝（申请被拒绝）

### 5.4 数据统计接口
`merchantApi.getOrderStats()` 返回格式：
```javascript
{
  pendingDelivery: 5,    // 待发货订单数
  todayOrders: 10,       // 今日订单数
  totalProducts: 20,      // 商品总数
}
```

### 5.5 错误处理
- 所有异步操作使用 `try-catch` 捕获错误
- 使用 `uni.showToast` 显示用户友好的错误提示
- 关键操作失败时提供重试机制

---

## 六、常见问题与解决方案

### Q1: 图片上传失败？
**A**: 
- 检查网络连接
- 检查图片大小（建议压缩）
- 检查后端上传接口是否正常（`src/pages/merchant/apply-shop.vue`）
- 查看控制台错误信息

### Q2: 订单列表为空？
**A**: 
- 检查当前店铺是否有订单（`src/pages/merchant/order-manage.vue`）
- 检查筛选条件是否正确
- 检查后端接口返回数据格式

### Q3: 发货后订单状态不更新？
**A**: 
- 确保发货后调用 `loadOrders()` 刷新列表（`src/pages/merchant/order-manage.vue`）
- 检查后端发货接口是否正常
- 检查订单状态码是否正确

### Q4: 店铺申请提交失败？
**A**: 
- 检查店铺名称是否符合要求（2-20字符）（`src/pages/merchant/apply-shop.vue`）
- 检查是否已上传头像
- 检查后端接口是否正常
- 查看控制台错误信息

---

## 七、代码规范建议

1. **命名规范**：使用驼峰命名，方法名使用动词开头
2. **注释规范**：关键逻辑添加注释说明
3. **错误处理**：所有异步操作都要有错误处理
4. **用户体验**：加载状态提示，操作反馈及时
5. **表单验证**：前端验证 + 后端验证双重保障

---

## 八、扩展功能建议

1. **订单管理**：可添加订单搜索、订单导出功能
2. **店铺申请**：可添加申请历史查看、重新申请功能
3. **数据统计**：可添加图表展示、数据导出功能

---

**文档版本**: v2.0  
**最后更新**: 2024年  
**维护者**: 乔雨林
